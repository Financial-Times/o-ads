version: 2
jobs:
  test_bower:
    docker:
      - image: circleci/node:10-browsers
    steps:
      - checkout
      - run: npm i
      - run: npm run obt -- install
      - run: npm run obt -- build
      - run: npm run checksizes
      - run: wget https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip && unzip ./BrowserStackLocal-linux-x64.zip
      # Running OBT test doesn't work because we need to pass a custom Karma
      # config to OBT which OBT doesn't support yet
      # command: npx origami-build-tools@^7 test
      - run: npm run test-unit
      - run:
          command: npm run demo-server
          background: true
      - run: npm run test-cy:run
      - run:
          command: ./BrowserStackLocal --key=$BROWSERSTACK_KEY
          background: true
      - run: sleep 5 && wget -qO- --retry-connrefused --no-check-certificate -T 60 http://localhost:3002
      - run: npm run test-nw
      - store-artifacts:
          path: test/cypress/videos
      - store-artifacts:
          path: test/cypress/screenshots
  test_npm:
    docker:
      - image: circleci/node:10-browsers
    steps:
      - checkout
      - run: npx occ 0.0.0
      - run: rm -f bower.json
      - run: npm i
      - run: npm run obt -- install --ignore-bower
      - run: npm run obt -- build --ignore-bower
      - run: wget https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip && unzip ./BrowserStackLocal-linux-x64.zip
      # Running OBT test doesn't work because we need to pass a custom Karma
      # config to OBT which OBT doesn't support yet
      # command: npx origami-build-tools@^7 test
      - run: npm run test-unit
      - run:
          command: npm run demo-server -- --ignore-bower
          background: true
      - run: npm run test-cy:run
      - run:
          command: ./BrowserStackLocal --key=$BROWSERSTACK_KEY
          background: true
      - run: sleep 5 && wget -qO- --retry-connrefused --no-check-certificate -T 60 http://localhost:3002
      - run: npm run test-nw
  publish_to_npm:
    docker:
      - image: circleci/node:10
    steps:
      - checkout
      - run: npx occ ${CIRCLE_TAG##v}
      - run: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > $HOME/.npmrc
      # - run: npx snyk monitor --org=customer-products --project-name=Financial-Times/o-ads
      - run: npm publish --access public

workflows:
  version: 2
  test:
    jobs:
      - test_npm
      - test_bower:
          requires:
            - test_npm
      - publish_to_npm:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
