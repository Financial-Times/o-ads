<!DOCTYPE html><html><head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta http-equiv="CACHE-CONTROL" content="NO-CACHE">
<title>Test DFP Ad on a page</title>
<link rel="stylesheet" href="../css/qunit-1.10.0pre.css">
<style type="text/css">
#banlb-not {
	height: 100px;
	width: 300px;
	background-color: pink;
	border: 1px solid black;
}

#mpu-not {
	height: 200px;
	width: 300px;
	background-color: blue;
	border: 1px solid black;
}

a img {
	border: none;
}

div {
	border: 1px solid black;
}

.advertising {
	border: 1px solid red;
}

.tempAds {
	display: none;
}

.warning {
	background-color: red;
}

#feedback {
	border: none;
}

#xpopad {
	display: none;
}
</style>

<script type="text/javascript">





/*members AYSC, CONST, ENV, FT_U, FTQA, Properties, adName, ads, adverts,
   asset, banlb, cookies, corppop, description, dfp_site, dfp_zone, doublet,
   env, getElementById, getLongestUrl, hlfmpu, injectUrlTrackCall, intro,
   isLegacyAPI, length, mktsdata, newssubs, next, oob, refresh, refreshTimer,
   regex, request, requestNewssubs, response, src, timeIntervalTolerance,
   timeoutTolerance, tlbxrib, trackUrl, urlThreshold, urlThresholdMax,
   useDFP, write, writeScript, writeScriptMock, FTQA, initDFP, lib, banlb3,
   newssubs2, corppop2, getCurrentYear, getFullYear,MockSubdir
*/

var FT = FT || {};
FT.env =
{
   "dfp_site": "test.5887.dev",
   "dfp_zone": "build-url-test",
   "asset":    "page",

   // Override timeout values to ensure the ad calls have time to come back
   // before the positions are collapsed. This is to ensure we can test the page successfully.
   "timeoutTolerance": 1500000,
   "timeIntervalTolerance": 3000000
};
// Mock the properties object so we are considered to be non-live
FT.Properties = { 'ENV': "ci" };
var CheckAds = ['intro', 'banlb', 'newssubs', 'tlbxrib', 'mktsdata', 'hlfmpu', 'doublet', 'oob', 'corppop', 'refresh'];
      </script>

<script src="../js/util/QUnitChainer.js"></script>
<script src="../js/util/test-helpers.html.js"></script>
<script src="../js/util/page-helpers.html.js"></script>

<script src="../lib/jquery/jquery-1.7.2.js"></script>
<script src="../js/util/jquery-ft-namespacing.js"></script>
<script src="../lib/jquery/jquery.cookie.js"></script>
<script src="../js/util/cookie.js"></script>
<script src="../lib/qunit/qunit-1.10.0pre.js"></script>

<script type="text/javascript">
//cookies can now be passed within a  get string to the page
setCookies();
var MockSubdir = true;
</script>

<script src="../../../../../../../main/webapp/media/js/lib/HeadCoreBundle/aop.js"></script>
<script src="../lib/jquery/jquery.cookie.js"></script>
<script src="../../../../../../../main/webapp/media/js/FT/Properties/Properties.js"></script>
<script src="../../../../../../../main/webapp/media/js/FT/Properties/Properties-int.js"></script>
<script src="../../../../../../../main/webapp/media/js/FT/CommonHeadBundle/Namespaces.js"></script>
<script src="../js/util/Lib.js"></script>
<script src="../js/util/cookie.js"></script>
<script src="../../../../../../../main/webapp/media/js/FT/CommonHeadBundle/pre-init.js"></script>
<script src="../js/ft/HTMLAds.js"></script>
<script src="../js/ft/DartForPublishers.js"></script>

<script src="../js/util/mock-ads.html.js"></script>
<script type="text/javascript">
// Clear the cookies which cause values to be inserted into the Ad calls.
//initCookies();

var Tests = {
   'intro': TestMockAd.intro,
   'banlb': TestMockAd.banlb3,
   'newssubs': TestMockAd.newssubs2,
   'tlbxrib': TestMockAd.tlbxrib,
   'mktsdata': TestMockAd.mktsdata,
   'hlfmpu': TestMockAd.hlfmpu,
   'doublet': TestMockAd.doublet,
   'oob': TestMockAd.oob,
   'corppop': TestMockAd.corppop2,
   'refresh': TestMockAd.refresh
};

var Plan = {
   title: 'Test DFP Ad on a page',
   nextTestPlan: 'ad-on-a-page-master-companion.html'   
};
QUnitChainer.init(Plan);

function getCurrentYear() 
{
      var currDate = new Date();
      return currDate.getFullYear();
}

FT.ads.initDFP();
FT.lib.writeScriptMock = function (URL)
{
   mockAdContent(URL, Tests); // Ads injected immediately
};

//now we find what test mode we are in and either call DFP (Integration) or Mock the ad call (unit)
var testMode = unitOrIntegrationMode(FT.cookies.FTQA);

if (testMode === 'unit')
{
   //if unit test, then we override FT.lib.writeScript with the call to Mocking
   FT.lib.writeScript = FT.lib.writeScriptMock;
}

// Clear the cookies which cause values to be inserted into the Ad calls.
initCookies();
module(Plan.title);


test("Page Environment", function ()
{
   expect(4);

   ok(FT.env,                                                                                      "FT.env should be defined");
   ok(FT.cookies,                                                                                  "FT.cookies should be defined");
   ok(FT.env.useDFP,                                                                               "FT.env.useDFP should be set to true");
   ok(!FT.env.isLegacyAPI,                                                                         "Legacy API should not be used");
});

test("intro", function ()
{
   expect(1);
   equal(FT.$('#intro_overlay').length, 1,                                                      'intro ad should be inserted into the DOM with count');
});

test("banlb", function ()
{
   expect(5);
   ok(true,                                                                                        "occasionally fails due to receipt of collapsed banlb master for 728x90 despite also getting a valid image -- investigate");
   testImageAd('banlb', 2);
});

test("interstitial off banlb", function ()
{
   expect(2);
   equal(FT.$('#interstitial_overlay').length, 1,                                               'interstitial ad should be inserted into the DOM with count');
   // the following check is in to check for interstitial corppop regression:
   equal(FT.$('#popad').length, 0,                                                              '#popad should not be present');
});

test("corppop off banlb", function ()
{
   expect(2);
   equal(FT.$('#corppop_overlay').length, 0,                                                    'div with #corpop_overlay should have count');
   equal(FT.$('.corppop_single_occurence').length, 0,                                           'there should no corp pop ad');
});

test("newssubs", function ()
{
   expect(4);
   testImageAd('newssubs');
});

test('tlbxrib', function ()
{
   expect(4);
   testImageAd('tlbxrib');
});

test('mktsdata', function ()
{
   expect(5);
   testImageAd('mktsdata');
   // test that we're getting the correct template-configured mktsdata ad back:
   equal(FT.$('#mktsdata span.sponsor').length, 1,                                              'should have a span.sponsor with count');
});

test("hlfmpu", function ()
{
   expect(4);
   testImageAd('hlfmpu');
});

test("doublet", function ()
{
   expect(2);
   equal(FT.$('#doublet .doublet-wrapper.doublet_first').length, 1,                             'doublet_first should occur with count');
   equal(FT.$('#doublet .doublet-wrapper.doublet_first').next('.doublet-wrapper.doublet_last').length, 1,     'doublet_last should be next with count');
});

test("refresh", function ()
{
   expect(9);
   testRefreshAd('refresh',undefined);
   equal(FT.ads.adverts.refresh.response.adName, 'refresh adjustment 32767',                      'refresh should correctly store obj value as');
   equal(FT.ads.adverts.refresh.response.refreshTimer, 32767000,                                  'refresh should correctly store refreshTimer value as');
});

test("FT.ads.injectUrlTrackCall() - for Task TA13272", function ()
{
   expect(3);

   // save old value
   var saved_urlThreshold = FT.ads.CONST.urlThreshold;
   // override default values
   FT.ads.CONST.urlThreshold = FT.ads.CONST.urlThresholdMax;
   FT.ads.CONST.trackUrl = "http://falcon.ft.com/track/dfp_error.gif?long_url=";
   // run function to inject image
   FT.ads.injectUrlTrackCall();
   // check that injected image exists
   var injectUrlTrackCallImage = document.getElementById("injectUrlTrackCall");

   ok(injectUrlTrackCallImage !== null,                                                            "injectUrlTrackCall image exists");
   
   matches(FT.ads.CONST.trackUrl + "?long_url=" + FT.ads.getLongestUrl(), ';u=uuid=build-url-test,ts=' + getCurrentYear(), "longest URL passed to tracking server contains u parameter with uuid and ts");
   equal(injectUrlTrackCallImage.src, FT.ads.CONST.trackUrl + "?long_url=" + FT.ads.getLongestUrl(),     "The src attribute of injected image should contain CONST.trackUrl and the longest URL");

   // restore original value
   FT.ads.CONST.urlThreshold = saved_urlThreshold;

   // src =getlongestUrl
});

      </script>
</head>

<body class="no-refresh">
	<h1 id="qunit-header"><a href="/~robinmarr/ft/svn/online/website/ft-cmsWeb/src/test/js/qunit/FT/RenderHeadBundle/Advertising/integration/ad-on-a-page.html">Test DFP Ad on a page</a> </h1>
	<h2 id="qunit-banner" class=""></h2>
	<h2 id="qunit-userAgent">Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/534.34 (KHTML, like Gecko) PhantomJS/1.7.0 Safari/534.34</h2>
	<p>
		The purpose of this page is to see the Falcon FT.ads library working
		with Dart for Publishers using the deepEqual page structure that is in use
		on the Falcon home pages i.e. <a href="http://www.ft.com/home/uk">http://www.ft.com/home/uk</a>
	</p>
	<p>
		<b>This page tests with targeting settings chosen to deliver ads.</b>
	</p>
	<p>The ads are booked under
	</p><ol>
		<li>Advertiser:<a title="Must use IE for this link" href="http://dfp.doubleclick.net/sso?useSso=true&amp;networkid=5887&amp;advertiserid=2389285">2389285</a>
					FT DFP Test 1 Account 
		</li>
		<li>Order:<a title="Must use IE for this link" href="http://dfp.doubleclick.net/sso?useSso=true&amp;networkid=5887&amp;orderid=3903162">3903162</a>
					Ongoing Test 
		</li>
		<li>Ad: Ongoing banlb 468x60 ID: <a title="Must use IE for this link" href="http://dfp.doubleclick.net/sso?useSso=true&amp;networkid=5887&amp;&amp;adid=217726086">217726086</a>
			and others.</li>
	</ol>
	<p></p>
	<p>
		And are targeted to DFP site/zone<b> <script type="text/javascript">
document.write(FT.env.dfp_site + '/' + FT.env.dfp_zone);
      </script>test.5887.dev/build-url-test
		</b>
	</p>
	<p>
		See <a href="ad-on-a-page-noads.html">ad-on-a-page-noads.html</a> for
		using the Falcon API with no targeted ads to see div collapse.
	</p>
	<p>
		See <a href="ad-on-a-page-legacy.html">ad-on-a-page-legacy.html</a>
		for using the Legacy Ads API with the Falcon library as for example on
		the blogs pages <a href="http://blogs.ft.com/dearlucy">http://blogs.ft.com/dearlucy</a>
	</p>
	<hr>
	<form>
		<input type="button" name="expand" value="expand" onclick="expandAll()" alt="show all Ad divs on the page"> <input type="button" name="diagnose" value="diagnose" onclick="showDiagnosis()" alt="display Ad diagnostics"> <input type="button" name="stop timer" value="stop timer" onclick="stopTimer()" alt="stop the interval timer">
	</form>
	<hr>
	<div id="mode">You are in UNIT TEST MODE. Set cookie FTQA=integration to switch to integration test mode.</div>
	<p id="qunit-testresult" class="result">Running...<br>&nbsp;</p><ol id="qunit-tests"></ol>

	<div id="main"></div>
	<!-- if in integration mode, make two calls to the adserver in order to correctly set the cookie for master / companion tracking -->
	<div id="dccookie" style="display: none">
		<script>unitOrIntegrationMessage(testMode);</script>
	</div>

	<hr>
	<p>From here down the page's div structure resembles the home page
		structure. Div's to hold the final ad location are just below.</p>
	<p>If no ads show, then there is something wrong with the code or
		with the ad targeting.</p>
	<div id="father-of-intro">
		<div id="fullpage-container">Ad request fullpage-container</div>
		<script type="text/javascript">
FT.cookies.FTQA = "ord=123123123";
FT.ads.request('intro');
</script>
<!-- ad ID: 219975130 creative ID: 34492273 -->
<style type="text/css">
   #intro_overlay {
      position: absolute; 
      top: 350px; 
      left: 600px; 
      width: 400px; 
      height: 250px;
      border: 4px solid black;
      padding: 4px;
      background: yellow;
      color:black;
      font-family: verdana, arial, helvetica, sans-serif;
      z-index: 100000;
   }
   #intro_overlay a {
      text-decoration: none;
   }
   #intro_overlay a:hover {
      text-decoration: underline;
   }
   #intro_overlay .close_button {
      float: right;
      margin: 5px 10px 0 0;
      font-weight: bold;
   }
   #intro_overlay .logo {
      float: left;
      margin: 5px 10px 0 0;
      font-weight: bold;
   }
</style>
<div id="intro_overlay">
   <div class="logo"><img src="../images/favicon.ico" width="64" height="64"></div>
   <div class="close_button" onclick="javascript: this.parentNode.style.display='none';">
      <a href="#">X</a>
   </div>
   <h2>intro</h2>
   <!-- The percent u macro below inserts the click through URL -->
   <h3><a href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a03/3/0/%2a/f%3B219975130%3B0-0%3B1%3B40911646%3B31-1/1%3B34492273/34510151/1%3B%3B%7Esscs%3D%3fhttp://www.ft.com/">1x1</a></h3>
</div>
	</div>
	<div class="clearfix container">
		clearfix container
		<div class="master-column middleSection" data-zone="middleSection">
			master-column middleSection
			<div class="master-row topAds">
				master-row topAds
				<div id="banlb" class="advertising">
					Ad request banlb
					<script type="text/javascript">
FT.ads.request("banlb");
            </script>
<img src="../images/banlb-728x90.gif" border="0" alt="Markets"><!-- ad ID: 220435672  creative ID: 34653048 -->
      <style type="text/css">
         #interstitial_overlay {
            position: absolute; 
            top: 20px; 
            left: 100px; 
            width: 500px; 
            height: 300px;
            border: 4px solid red;
            padding: 4px;
            background: black;
            color:white;
            font-family: verdana, arial, helvetica, sans-serif;
            z-index: 100000;
         }
         #interstitial_overlay a {
            text-decoration: none;
         }
         #interstitial_overlay a:hover {
            text-decoration: underline;
         }
         #interstitial_overlay .close_button {
            float: right;
            margin: 5px 10px 0 0;
            font-weight: bold;
         }
         #interstitial_overlay .logo {
            float: left;
            margin: 5px 10px 0 0;
            font-weight: bold;
         }
      </style>
      <div id="interstitial_overlay" class="new_interstitial">
         <!-- The percent i macro below records the interstitial impression when served -->
         <div class="logo"><img src="../images/favicon.ico" width="64" height="64"></div>
         <div class="close_button" onclick="javascript: this.parentNode.style.display='none';">
            <a href="#">X</a>
         </div>
         <h2>interstitial</h2>
         <!-- The percent u macro below inserts the click through URL -->
         <h3><a href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a06/2/0/%2a/v%3B220435672%3B0-0%3B0%3B40911646%3B255-0/0%3B34653048/34670926/1%3B%3B%7Esscs%3D%3fhttp://www.ft.com">1x1</a></h3>
      </div>

				</div>
				<div id="newssubs" class="advertising">
					Ad request newssubs
					<script>

FT.ads.requestNewssubs();

            </script>
<img src="../images/3-newssubs-239x90.GIF" border="0" alt="FT.com Test Ads DEV">
				</div>
			</div>
			<div class="master-row railSection" data-zone="railSection">
				master-row railSection
				<div id="tlbxrib" class="advertising">
					Ad request tlbxrib
					<script type="text/javascript">
FT.ads.request("tlbxrib");
            </script>
<!-- Template ID = 12548 Template Name = FT Default House Ad (non-Falcon) -->
<!-- Ad ID: 219975011 Creative ID: 35188481 -->
<span class="dfp-ad-details" style="display:none">AdvId: 2389285 AdId: 219975011 CrId: 35188481</span>
<a href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a03/3/0/%2a/c%3B219975011%3B0-0%3B1%3B40911646%3B2383-336/60%3B35188481/35206299/1%3B%3B%7Esscs%3D%3fhttp://www.google.com" target="_top">
<img border="0" alt="FT.com Test Ads DEV" src="../images/tlbxrib-336x60.GIF"></a>

				</div>
				<div class="freestyle">
					freestyle
					<div id="wsodHomePageModule" class="rightRailComponent">
						Ad request wsodHomePageModule
						<div id="wsodHomePageModuleContent">
							Ad request wsodHomePageModuleContent
							<div class="advertising" id="mktsdata">
								Ad request mktsdata
								<!-- <span class="advert" style="width: 75px; height: 25px; margin-top: -3px;"> -->
								<script type="text/javascript">
FT.ads.request("mktsdata");
                        </script>
<span class="sponsor" style="margin: 2px 0pt 0pt -75px; position: absolute;">Sponsored by</span><a target="_blank" href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a03/3/0/%2a/v%3B219975169%3B0-0%3B1%3B40911646%3B486-75/25%3B34598218/34616096/1%3B%3B%7Esscs%3D%3fhttp://www.ft.com"><img width="75" height="25" border="0" src="../images/mktsdata-75x25.gif"></a>
								<!--   </span> --->
							</div>
						</div>
					</div>
				</div>

				<div id="hlfmpu" class="advertising">
					Ad request hlfmpu
					<script type="text/javascript">
FT.ads.request("hlfmpu");
            </script>
<a target="_blank" href="http://ad.doubleclick.net/click;h=v8/3a03/0/0/%2a/k;218040804;0-0;2;40911646;4252-336/280;33373875/33391753/1;;~sscs=%3fhttp://www.ft.com"><img src="../images/1-halfmpu336x280.gif" border="0" alt="FT.com Test Ads DEV"></a>
				</div>
				<div class="railComponent togglable maximised advertising">
					railComponent togglable maximised advertising <span class="toggleButton"> </span>
					<h3 class="">
						<span class="railComponentHeading"> Highlights </span>
					</h3>
					<div class="toggleContent">
						toggleContent
						<div id="doublet">
							Ad request doublet
							<script type="text/javascript">
FT.ads.request("doublet");
                  </script>
[<div class="doublet" style="background: cyan"><h3>DOUBLET AD</h3><div class="doublet-wrapper doublet_first"><div class="doublet-content"><h4><a href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a03/3/0/%2a/t%3B220021083%3B0-0%3B1%3B40911646%3B16843-342/200%3B34473321/34491199/1%3B%3B%7Esscs%3D%3fhttp://politicalhumor.about.com/od/barackobama/ig/Barack-Obama-Cartoons/">DOUBLET ADVERT 1</a></h4><a href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a03/3/0/%2a/t%3B220021083%3B0-0%3B1%3B40911646%3B16843-342/200%3B34473321/34491199/1%3B%3B%7Esscs%3D%3fhttp://politicalhumor.about.com/od/barackobama/ig/Barack-Obama-Cartoons/"><img src="../images/doublet-1-169x96.jpg" alt="Ad 1 Alt Text"></a><p><a href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a03/3/0/%2a/t%3B220021083%3B0-0%3B1%3B40911646%3B16843-342/200%3B34473321/34491199/1%3B%3B%7Esscs%3D%3fhttp://politicalhumor.about.com/od/barackobama/ig/Barack-Obama-Cartoons/">Advert 1 Subheading</a></p></div></div><div class="doublet-wrapper doublet_last"><div class="doublet-content"><h4><a href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a03/3/0/%2a/t%3B220021083%3B0-0%3B1%3B40911646%3B16843-342/200%3B34473321/34491199/1%3B%3B%7Esscs%3D%3fhttp://xkcd.com/">DOUBLET ADVERT 2</a></h4><a href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a03/3/0/%2a/t%3B220021083%3B0-0%3B1%3B40911646%3B16843-342/200%3B34473321/34491199/1%3B%3B%7Esscs%3D%3fhttp://xkcd.com/"><img src="../images/doublet-2-169x96.jpg" alt="Advert 2 Alt Text"></a><p><a href="http://ad.doubleclick.net/click%3Bh%3Dv8/3a03/3/0/%2a/t%3B220021083%3B0-0%3B1%3B40911646%3B16843-342/200%3B34473321/34491199/1%3B%3B%7Esscs%3D%3fhttp://xkcd.com/">Advert 2 Subheading</a></p></div></div></div>].join("
")
						</div>
					</div>
				</div>

			</div>
		</div>
		<div class="adRequests">
			adRequests
			<div id="oob">
				Ad request oob
				<script type="text/javascript">
FT.ads.request('oob');
         </script>
			</div>
			<div id="corppop">
				Ad request corppop
				<script type="text/javascript">
//make sure no local corppop ads are served by setting the cookie
FT.cookies.CorpPopTimeout = 'set';
FT.ads.request('corppop');
         </script>
			</div>
			<div id="refresh" class="advertising" style="display: none; ">
				Ad request refresh
				<script type="text/javascript">
FT.ads.request('refresh');
         </script>
<img src="../images/ft-refresh-1x1.gif">
			</div>

		</div>
	</div>

	<hr>
	<form>
		<input type="button" name="expand" value="expand" onclick="expandAll()" alt="show all Ad divs on the page"> <input type="button" name="diagnose" value="diagnose" onclick="showDiagnosis()" alt="display Ad diagnostics"> <input type="button" name="stop timer" value="stop timer" onclick="stopTimer()" alt="stop the interval timer">
	</form>
	<hr>
	<script type="text/javascript" src="../js/util/test-helpers.html.js"></script>

</body></html>